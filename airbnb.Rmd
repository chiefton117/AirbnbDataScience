---
title: "AirBNB Data Analysis"
author: "Tim Harrold, Madison brown, Yifei Hao"
date: "3/10/2021"
output: html_document
---

Relationships/graphs: 

- Price vs. Rating

- stop words

- Map of NYC

- Box plot

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(devtools)
library(maps)
library(leaflet)
library(ggmap)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggwordcloud)

# The map theme taken from the book
theme_map <- function(base_size=9, base_family="") {
    require(grid)
    theme_bw(base_size=base_size, base_family=base_family) %+replace%
        theme(axis.line=element_blank(),
              axis.text=element_blank(),
              axis.ticks=element_blank(),
              axis.title=element_blank(),
              panel.background=element_blank(),
              panel.border=element_blank(),
              panel.grid=element_blank(),
              panel.spacing=unit(0, "lines"),
              plot.background=element_blank(),
              legend.justification = c(0,0),
              legend.position = c(0,0)
              )
}

```

## Setting up the project

First, get our data from:

http://insideairbnb.com/get-the-data.html


To create these two files, right click the files listings.csv.gz and reviews.csv.gz separately, and click "extract here" or "extract to -> listings.csv", just like we extract the .zip files in class

Before committing and pushing, go to github desktop after you have the data files. Where it lists each file with a checkbox, right click the data files "listings.csv,reviews.csv,listings.csv.gz" and click:     
"ignore all .csv files(add to .gitignore)", then     
"ignore all .gz files(add to .gitignore)". 

If the data files are not removed from the list, right click them again and click "Ignore File(add to .gitignore). This will make it so you don't submit large data to the cloud. Github will not accept these large files(even the compressed ones) because of the size of our data.

```{r setup}


listings <- read.csv('listings_NYC.csv');
reviews <- read.csv('reviews_NYC.csv');

```

## Make some graphs! 


```{r listings, echo=FALSE}


tibble(listings)
listings$priceNum <- as.numeric(gsub('[$,]', '', listings$price))

ggplot(data = listings, mapping = aes(x=neighbourhood_group_cleansed, color=neighbourhood_group_cleansed)) +
  geom_boxplot()

ggplot(data = listings, mapping = aes(x=neighbourhood_group_cleansed, fill=neighbourhood_group_cleansed)) +
  geom_density()


ggplot(data = listings %>% filter(priceNum < 400), mapping = aes(x=priceNum, fill=neighbourhood_group_cleansed)) +
  geom_density() +
  facet_wrap(~ neighbourhood_group_cleansed)

ggplot(data = listings %>% filter(priceNum < 400), mapping = aes(x=priceNum, fill=neighbourhood_group_cleansed)) +
  geom_bar()

ggplot(data = listings, mapping = aes(x=priceNum, y=review_scores_rating, color=neighbourhood_group_cleansed)) +
  geom_point() +
  facet_wrap(~ neighbourhood_group_cleansed)


#ggplot(data = listings, mapping = aes(x=number_of_reviews, y=priceNum, color=neighbourhood_group_cleansed)) +
#  geom_point()




```
## Stop Words 

``` {r stopWords}

stopWords <- c("a", "about", "above", "above", "across", "after", "afterwards", "again", "against", "all", "almost", 
    "alone", "along", "already", "also","although","always","am","among", "amongst", "amoungst", "amount",  
    "an", "and", "another", "any","anyhow","anyone","anything","anyway", "anywhere", "are", "aren't", "around", "as",  
    "at", "back", "bc", "be","became", "because","become","becomes", "becoming", "been", "before", "beforehand", "behind", 
    "being", "below", "beside", "besides", "between", "beyond", "bill", "both", "bottom","but", "by", "call", 
    "can", "cannot", "cant", "chaqueta", "chayda", "co", "con", "could", "couldnt", "de", "definitely", "definetely", "defin", "describe", "detail", "did", "do", "doesn", "doesn't", "done", "don't", 
    "down", "due", "during", "each", "eg", "eight", "either", "eleven","else", "elsewhere", "empty", "enough", "episode", 
    "etc", "even", "ever", "every", "everyone", "everything", "everywhere", "except", "few", "fifteen", "fify", 
    "fill", "find", "fire", "first", "five", "for", "former", "formerly", "forty", "found", "four", "from", 
    "front", "full", "further", "get", "give", "go", "going", "had", "has", "hasnt", "have", "he", "hello", "hence", "her", 
    "here", "hereafter", "hereby", "herein", "hereupon", "hers", "herself", "him", "himself", "his", "how",
    "however", "hundred", "i", "ie", "if", "i'll", "in", "inc", "indeed", "interest", "into", "is", "it", "its", "itâ€™s", "itself", "i've", "just",
    "keep", "last", "latter", "latterly", "least", "leave", "less", "let's", "like", "ltd", "made", "many", "may", "me", "met", "meanwhile", "message",
    "might", "mill", "mine", "more", "moreover", "most", "mostly", "move", "much", "must", "my", "myself", 
    "name", "namely", "neither", "never", "nevertheless", "next", "nine", "no", "nobody", "none", "noone", "nsure", 
    "nor", "not", "nothing", "now", "nowhere", "nthe", "of", "off", "often", "on", "once", "one", "only", "onto", "or", 
    "other", "others", "otherwise", "our", "ours", "ourselves", "out", "over", "own","part", "per", "perhaps", 
    "please", "put", "rather", "re", "same", "see", "seem", "seemed", "seeming", "seems", "serious", "several", 
    "she", "should", "show", "side", "since", "six", "sixty", "so", "some", "somehow", "someone", 
    "something", "sometime", "sometimes", "somewhere", "still", "such", "take", "takes", "ten", "than", 
    "that", "thats", "the", "their", "them", "themselves", "the", "then", "thence", "there", "thereafter", "thereby", "therefore", 
    "therein", "thereupon", "these", "they", "thick", "thin", "third", "this", "those", "though", "three", 
    "through", "throughout", "thru", "thus", "to", "together", "too", "told", "top", "toward", "towards", "twelve", 
    "twenty", "two", "un", "under", "until", "up", "upon", "us", "very", "via", "was", "way", "we", "well", "were", 
    "what", "whatever", "when", "whence", "whenever", "where", "whereafter", "whereas", "whereby", "wherein",
    "whereupon", "wherever", "whether", "which", "while", "whither", "who", "whoever", "whole", "whom", "whose", 
    "why", "will", "with", "within", "without", "would", "year", "years", "yet", "you", "your", "you're", "yours", "yourself", "yourselves", "ve", "")

# replace reviews listing id for join
reviews$id <- reviews$listing_id


ordered <- listings %>%
  select(id, priceNum, neighbourhood_group_cleansed, review_scores_rating) %>%
  group_by(id, neighbourhood_group_cleansed) %>%
  filter(review_scores_rating == max(review_scores_rating)) %>%
  arrange(desc(review_scores_rating), desc(priceNum))

joined <- as.data.frame(left_join(ordered, reviews, by="id"))

avg_review <- sample_n(joined, 20)
best_review <- head(joined, n=20)
worst_review <- tail(joined, n=20)

```

## Reviews 

```{r reviews}

# Takes in a data frame and scrubs the review variable with regex - taking out punctuation, numbers and newlines
filter_regex <- function(data) {
  
  # filter data with regex
  sample <- tolower(gsub("[\\\r\n[:digit:]+]","",data, perl=TRUE, fixed = FALSE))
  sample <- gsub('[[:punct:] ]+',' ',sample)
  
  # remove stop words and all 3 letter or less words
  words <- data.frame(word = setdiff(str_split(sample, " ", simplify=TRUE), stopWords)) %>% 
    filter(nchar(word) > 3)
  
  # add integer attribute for repeated words
  freqs <- words %>% count(word) %>% arrange(desc(n))
  
}

# Create our data frames by filtering reviews
best <- filter_regex(best_review)
avg <- filter_regex(avg_review)
worst <- filter_regex(worst_review)

ggplot(data=best, mapping=aes(label=word,size=n)) +
  geom_text_wordcloud(rm_outside = TRUE) +
  theme_bw() +
  labs(title="Top 10 Listings - Word Frequency")

ggplot(data=avg, mapping=aes(label=word,size=n)) +
  geom_text_wordcloud(rm_outside = TRUE) +
  theme_bw() +
  labs(title="Average 10 Listings - Word Frequency")

ggplot(data=worst, mapping=aes(label=word,size=n)) +
  geom_text_wordcloud(rm_outside = TRUE) +
  theme_bw() +
  labs(title="Worst 10 Listings - Word Frequency")

```


## Box Plot of Price
```{r boxplot}
boxplot <- as.data.frame(sample_n(listings, 1500))

ggplot(data = boxplot %>% filter(priceNum < 2000), 
       mapping = aes(x = neighbourhood_group_cleansed, y = priceNum, fill = neighbourhood_group_cleansed)) +
  geom_boxplot()
  

```

## Scatter plot of Ratings by Price

```{r scatter}
scatter <- as.data.frame(sample_n(listings, 1000))

ggplot(data = scatter, mapping = aes(x = priceNum, y = number_of_reviews, color = neighbourhood_group_cleansed)) +
  geom_point() +
  theme_bw() 

```

## Map of NYC (WHAT IS OUR VARIABLE?)
Show price and/or reviews in each neighborhood
```{r maps, force = TRUE, message=FALSE, warning=FALSE}

subset <- sample_n(listings, 2000)

stdev <- sd(subset$priceNum)
mean <- mean(subset$priceNum)

# This is within one standard deviation of the mean
sData <- subset %>% filter(priceNum > (mean - stdev) & priceNum < (mean + stdev))
# This is within two standard deviations of the mean
sd2Data <- subset %>% filter(priceNum > mean - (2*stdev) & priceNum < mean + (2*stdev))


#sData <- sample_n(listings, 500) %>% filter(priceNum > mean - stdev & priceNum < mean + stdev)

# Check how full our dataset is, between stdevs
ggplot(data = sData, mapping = aes(x = priceNum)) +
  geom_histogram()

# Plot price against rating to confirm correlation
ggplot(data = sData, mapping = aes(x = priceNum, review_scores_rating)) +
  geom_point()

clrs <- colorBin(palette = "RdYlBu", domain = sData$priceNum, reverse = TRUE, bins = 11, na.color = NA)
#clrs <- colorQuantile(palette = "RdYlBu", domain = sData$priceNum, reverse = TRUE, na.color = NA)

# plot price on map, not sure what the actual markers signify?
leaflet(sData) %>%
  addTiles() %>%
  addCircleMarkers(data = sData,
           lng = ~longitude,
           lat = ~latitude,
           color = ~clrs(priceNum),
           stroke = FALSE, fillOpacity = 0.4, radius = 4) %>%
  addLegend("bottomright", pal = clrs, values = ~priceNum,
    title = "Price",
    labFormat = labelFormat(prefix = "$"),
    opacity = 1) %>%
  addMarkers( clusterOptions = markerClusterOptions() ) %>%
  setView(-74.00, 40.71, zoom = 12) %>%
  addProviderTiles("CartoDB.Positron")

#clrsrev <- colorBin(palette = "RdYlBu", domain = sData$review_scores_rating, reverse = TRUE, na.color = NA)
clrsrev <- colorBin(palette = "RdYlBu", domain = sData$review_scores_rating, reverse = TRUE, na.color = NA)

# Where are most reviews found, and how much are they?
# Markers are stored on review scores < 60
leaflet(sData %>% filter(review_scores_rating < 60)) %>%
  addTiles() %>%
  addCircleMarkers(data = sData %>% filter(!is.na(review_scores_rating)),
           lng = ~longitude,
           lat = ~latitude,
           color = ~clrsrev(review_scores_rating),
           stroke = FALSE, fillOpacity = 0.4, radius = 4) %>%
  addLegend("bottomright", pal = clrsrev, values = ~review_scores_rating,
    title = "Review Score",
    opacity = 1) %>%
  addMarkers( clusterOptions = markerClusterOptions() ) %>%
  setView(-74.00, 40.71, zoom = 12) %>%
  addProviderTiles("CartoDB.Positron")






```
