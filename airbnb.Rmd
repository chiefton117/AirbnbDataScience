---
title: "AirBNB Data Analysis"
author: "Tim Harrold, Madison Brown, Yifei Hao"
date: "3/10/2021"
output: 
  html_document:
      toc: true
      code_folding: hide
      df_print:  paged 
---


*TODO*

- Regression line to amenities
- Get specific amenities
- Machine Learning
- Filtering for amenities


Multiple Regression Vars
"review_scores_rating", "review_scores_accuracy", "review_scores_cleanliness", "review_scores_checkin", "review_scores_communication", "review_scores_location", "review_scores_value"



*NOTE: There will be a PDF and HTML document submitted for this project. The PDF contains everything significant in the report, but the HTML file will allow you to use the interactive leaflet.*

Our data was sourced from Airbnb's website: http://insideairbnb.com/get-the-data.html    

In this analysis we will be observing qualitative and quantitative characteristics to discover the variation in Airbnbs throughout New York City, and what makes the best Airbnb experience. We ask the question, which characteristics are correlated with a better reported experience?    

This analysis will include graphs to show the relationships between price and neighborhood, rating and neighborhood, rating and number of reviews, and rating and review stop words. We will be using tables, density plots, scatter plots, and maps to analyze the correlations between these variables. To give a qualitative analysis of peoples stays, we will be using word cloud to filter keywords from the reviews. A map of the city will provide spacial information on where the most vs least expensive Airbnbs are located in the city.

We don't believe in any sampling bias by Airbnb in this observational 'study', as this data is from an objective database of ALL airbnb listings. These listings included metadata that we're pulling from, such as price, reviews, and location. However, it is possible that the qualitative elements such as amenities may be biased, as these are up to the property owners to create. Some owners may oversell their listing. This bias hopefully will be overcome by the reviews of said listing.    

There was a lot of data cleaning done to produce this data over many iterations. A private github repo / git log of all commits can be produced upon request. Some methods include:    

- Scrubbing language of all punctuation and non-alphanumeric characters using regular expressions
- Counting word frequencies
- Counting elements in lists present in the data
- Taking a random sample of the data and finding a subset within one std deviation of the mean
- Removing extraneous values from graphs for easier viewing    

This data is interesting because it is real. AirBNB is becoming a more viable alternative to hotels or motels because they are cheaper, cozier, and closer to the city experience than a hotel. Each experience is unique, making it hard to know exactly what a good AirBNB looks like. Finding these qualities can make your next vacation better, and help you do your research before committing to plans.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(devtools)
library(maps)
library(leaflet)
library(ggmap)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggwordcloud)
library(grid)
library(gridExtra)
library(C50)


listings <- read.csv('listings_NYC.csv');
reviews <- read.csv('reviews_NYC.csv');

# In the setup chunk, create a numeric casting of price for analysis in the rest of the code

listings$priceNum <- as.numeric(gsub('[$,]', '', listings$price))


```


## Mapped Listings by Price

*Here, we tried to utilize ggmaps and ggplot before resorting to leaflet for our map. I tried mapping the review scores, which didn't quite display right. Most scores are very high, even when mapping 68% of the data within one standard deviation of the mean.*

*The other challenge was taking a small enough subset of the data to map without crashing a computer(three computer crashes were involved in the making of this report). Leaflet offers multiple coloring methods, such as numerical, bin-based, and quantile-based. Quantiles ended up working especially well for this map.*

We hypothesized that the Bronx and Brooklyn would have a higher concentration of lower priced Airbnbs than Staten Island and Manhattan. Our hypothesis is only partially correct. Brooklyn has a similar distribution to Staten Island, and Queens has a similar distribution to the Bronx. Our hypothesis was supported in the case of the Bronx and Manhattan. 

This map also has some interesting findings in the density of properties, and their price. The listings get much more dense the further into Manhattan you go, second to Queens and Brooklyn. Interestingly, price also increases as you get into these areas. As per our earlier findings, Manhattan and Brooklyn are the most expensive boroughs to stay in.

Within Manhattan, values get more dense and more expensive towards the south end. This is the financial district of NYC, where most skyscrapers and businesses are. Perhaps people with financial interests, or wealthier individuals like Wall Street bankers stay in pricier AirBNB's. SoHo and Greenwich Village are also in this part of Manhattan, which must be more expensive.

When people visit NYC, they want to be closer to the center of the city. They likely pay more for staying in or near Manhattan - where most tourist attractions are.     

```{r maps, force = TRUE, message=FALSE, warning=FALSE}

set.seed(200)
subset <- sample_n(listings, 3000)

stdev <- sd(subset$priceNum)
mean <- mean(subset$priceNum)


# This is within one standard deviation of the mean
sData <- subset %>% filter(priceNum > (mean - stdev) & priceNum < (mean + stdev))
# This is within two standard deviations of the mean
sd2Data <- subset %>% filter(priceNum > mean - (2*stdev) & priceNum < mean + (2*stdev))

clrs <- colorQuantile(palette = "RdYlBu", domain = sData$priceNum, reverse = TRUE, na.color = NA)

# plot price on map, not sure what the actual markers signify?
leaflet(sData) %>%
  addTiles() %>%
  addCircleMarkers(data = sData,
           lng = ~longitude,
           lat = ~latitude,
           color = ~clrs(priceNum),
           stroke = FALSE, fillOpacity = 0.4, radius = 4) %>%
  addLegend("bottomright", pal = clrs, values = ~priceNum,
    title = "Price(Quantile)",
    labFormat = labelFormat(prefix = ""),
    opacity = 1) %>%
  addMarkers( clusterOptions = markerClusterOptions() ) %>%
  setView(-74.00, 40.71, zoom = 12) %>%
  addProviderTiles("CartoDB.Positron")

```


## Density by Price

This graph show the density of Airbnbs with different review scores within the five boroughs.  We hypothesized that the Bronx and Brooklyn would have the higher densities of lower reviewed Airbnbs than Staten Island and Manhattan. Our hypothesis is only partially correct. Brooklyn has a similar distribution to Manhattan. There are more Airbnbs in these boroughs with very high ratings than there are in the other boroughs. Our hypothesis was supported in the case of the Bronx, queens, and Staten Island. The distribution of ratings is similar among these boroughs. Manhattan and Brooklyn are more expensive and desirable boroughs for living and tourism. This not only increases the price, but may also affect quality. The quality of Airbnbs among the boroughs is likely reflected in the review scores. 


*We attempted to arrange the facet_wrap into one column to make reading the graphs and comparing the boroughs easier. This stretched out each graph and did not help with readability. It is easiest to read facet_wrap with three columns. 

```{r listings, warning = FALSE}

ggplot(data = listings, mapping = aes(x=review_scores_rating, fill=neighbourhood_group_cleansed)) +
  geom_density() +
  facet_wrap(~ neighbourhood_group_cleansed) +
  guides(fill = FALSE) +
  labs(title = "Airbnb Density by Review Score",
       x = 'Review Score',
       y = 'Density') +
  theme(plot.title = element_text(size= 15, face = 'bold')) +
  theme_bw() 
  


```


## Review Scores by Price

This graph shows the review score by price of Airbnbs in each borough. We hypothesized that there would be a positive correlation between price and review score. The data show that higher priced Airbnbs tend to have high review scores. Most of the multithousand dollar Airbnbs do not have review scores below 80. Although more expensive Airbnbs trend towards higher scores, this does not mean that cheaper Airbnbs trend towards lower scores. The Airbnbs with the lower scores tend to be the cheaper ones; However, less expensive Airbnbs also have high scores. From this, we conclude that price has less impact on cheaper Airbnb review scores than expensive ones. 

*scale_x_log10() was used to make the graphs more readable.

```{r scatter, warning = FALSE}

a1 <- ggplot(data = listings, mapping = aes(x=priceNum, y=review_scores_rating, color=neighbourhood_group_cleansed)) +
  geom_point() +
  scale_x_log10() +
  facet_wrap(~ neighbourhood_group_cleansed) +
  labs(title = 'Review Scores by Price',
       subtitle = 'With Applied log10 Transformation',
       x = 'Price',
       y = 'Review Score') +
  theme_bw()

# using guides(fill = FALSE) did not work to remove our legend, so we unfortunately had to go with theme()
# we understand this is not the best way to do it, but it seemed to work the best

a1 + theme(plot.title = element_text(size=15, face = 'bold'), legend.position = "none")

```


## Stop Words 

For this part of the analysis, we will take 20 listings from the top and bottom of the data, then sample another 20 randomly. We will then filter these through a list of stop words(deemed irrelevant to the data) to find relevant and unique words to describe these experiences.

``` {r stopWords}

# First, we'll define our array of stop words
stopWords <- c("airbnb", "a", "about", "above", "above", "across", "after", "afterwards", "again", "against", "algo", "all", "almost", 
    "alone", "along", "alojen", "already", "also","although","always","am", "ammar","among", "amongst", "amoungst", "amount",  
    "an", "and", "another", "any","anyhow","anyone","anything","anyway", "anywhere", "are", "aren't", "arrive", "arrived", "around", "as",  
    "at", "back", "bc", "be","became", "because", "becky", "become","becomes", "becoming", "been", "before", "beforehand", "behind", 
    "being", "below", "beside", "besides", "between", "beyond", "bill", "both", "bottom","but", "by", "call", 
    "can", "cannot", "cant", "card","chaqueta", "chayda", "co", "con", "could", "couldnt", "de", "definitely", 
    "definetely", "dell", "defin", "describe", "detail", "did", "do", "doesn", "doesn't", "done", "don't", "down", "due", "during", 
    "each", "eg", "eight", "either", "eleven","else", "elsewhere", "empty", "enough", "episode", 
    "etc", "even", "ever", "every", "everyone", "everything", "everywhere", "except", "few", "fifteen", "fify", 
    "fill", "find", "fire", "first", "five", "for", "former", "formerly", "forty", "found", "four", "from", 
    "front", "full", "further", "get", "give", "go", "going", "had", "has", "hasnt", "have", "he", "hello", "hence", "her", 
    "here", "hereafter", "hereby", "herein", "hereupon", "hers", "herself", "him", "himself", "his", "how",
    "however", "hundred", "i", "ie", "if", "i'll", "in", "inc", "indeed", "interest", "into", "is", "it", "its", "it’s", "itself", "i've", "just",
    "keep", "la", "last", "latter", "latterly", "least", "leave", "less", "let's", "like", "ltd", "made", "many", "may", "me", "met", "meanwhile", "message",
    "might", "mill", "mine", "more", "moreover", "most", "mostly", "move", "much", "must", "my", "myself", 
    "name", "namely", "neither", "never", "nevertheless", "next", "nine", "no", "nobody", "none", "noone", "nsure", 
    "nor", "not", "nothing", "now", "nowhere", "nthe", "of", "off", "often", "on", "once", "one", "only", "onto", "or", 
    "other", "others", "otherwise", "our", "ours", "ourselves", "out", "over", "own", "para","part", "per", "perhaps", "place", 
    "please", "put", "rather", "re", "room", "same", "see", "seem", "seemed", "seeming", "seems", "serious", "several", 
    "she", "should", "show", "side", "since", "six", "sixty", "so", "some", "somehow", "someone", 
    "something", "sometime", "sometimes", "somewhere", "still", "such", "take", "takes", "ten", "than", 
    "that", "thats", "the", "their", "them", "themselves", "the", "then", "thence", "there", "thereafter", "thereby", "therefore", 
    "therein", "thereupon", "these", "they", "thick", "thin", "third", "this", "those", "though", "three", 
    "through", "throughout", "thru", "thus", "to", "together", "too", "told", "top", "toward", "towards", "twelve", 
    "twenty", "two", "un", "under", "until", "up", "upon", "us", "very", "via", "was", "way", "we", "well", "were", 
    "what", "whatever", "when", "whence", "whenever", "where", "whereafter", "whereas", "whereby", "wherein",
    "whereupon", "wherever", "whether", "which", "while", "whither", "who", "whoever", "whole", "whom", "whose", 
    "why", "will", "with", "within", "without", "would", "year", "years", "yet", "you", "your", "you're", "yours", "yourself", "yourselves", "ve", "", " ")

# replace reviews listing id for join
reviews$id <- reviews$listing_id

# create a new joined frame with less data and grouped listings, for easier analysis
ordered <- listings %>%
  select(id, priceNum, neighbourhood_group_cleansed, review_scores_rating) %>%
  group_by(id, neighbourhood_group_cleansed) %>%
  filter(review_scores_rating == max(review_scores_rating)) %>%
  arrange(desc(review_scores_rating), desc(priceNum))

joined <- as.data.frame(left_join(ordered, reviews, by="id"))

# take samples of the data frame from the top, bottom, and (hopefully) middle
avg_review <- sample_n(joined, 20)
best_review <- head(joined, n=20)
worst_review <- tail(joined, n=20)

# Takes in a data frame and scrubs the review variable with regex - taking out punctuation, numbers and newlines
# NOTE: THIS DATA FRAME MUST HAVE A CHARACTER ATTRIBUTE 'COMMENTS'
filter_regex <- function(data) {
  
  # filter data with regex
  data$comments <- gsub("[^a-zA-Z ]","",data$comments, perl=TRUE, fixed = FALSE)
  
  # split strings and put frequencies in a table
  words <- data.frame(table(unlist(strsplit(tolower(data$comments), " "))))
  
  # name columns and remove stop words
  colnames(words) <- c("word", "count")
    
  words <- words %>% filter((!(words$word %in% stopWords)))
  
}

# Create our data frames by filtering reviews
best <- filter_regex(best_review)
avg <- filter_regex(avg_review)
worst <- filter_regex(worst_review)



```

## Reviews Word Analysis

The first correlation I noticed is the use of more abstract words against the expreience of each airbnb. When a place is better, words like "great", "easy", "flexible",  and "confidence" are used. The finding here is that a better experience may not be distinct in what makes it amazing, but rather there is a lack of inconvenience. It seems that people also value communication and accessibility in their AirBNB experience. "resposive", "accommodating", and many names are listed in these reviews. Perhaps there was a personal element to the stays that added to the experience. It is also worth noting that this is the only word cloud that easily fit into its box - people have a lot less to say when they are satisfied than when they are upset.

Average reviews were somewhere in the middle, where "clean", "available", and "comfortable" showed up often. These aren't generally descriptive of an exceptional experience, and moreso meet the baseline of a good AirBNB. Accessibility is still mentioned with "access", "communication", and "easy". Less names are mentioned in this data, but they are still present. Some people may have had better experiences when more names were mentioned. "Apartment" showed up more than any other word, as was the case with the top 20 graph. In New York City, apartments likely make up most properties. An average stay would probably be in an apartment(although some were in bungalows, apparently).

In our worst experiences, lots of red flags immediately come up. "Felons", "Smell", and "Homeless" are evidently bad. The learning here is the usage of less abstract words and more nouns. It seems specific things were present, and people have a lot to say about specific aspects of their stay. "Bathroom", "Room", "Water", "Basement" and "Smoke" showed up often - these things must contribute to negative experiences. People do not mention accessibility OR names, meaning the owners may not even be present for the experience. Where the best and average stays mentioned apartments, the worst experiences are "places".

Some interesting anomalies in the bad experiences include "sin", "knees", "cameras", "ghost", and "pathological" - one can easily imagine a bad scenario with these words.



```{r reviews, message=FALSE, warning=FALSE}

# Create some word clouds
w1 <- ggplot(data=best, mapping=aes(label=word,size=count)) +
  geom_text_wordcloud(rm_outside = TRUE, area_corr_power = 1) +
  scale_size_area(max_size = 8) +
  theme_bw() +
  labs(title="NYC AirBnb Unique Word Frequency", subtitle="Top 20 Reviews")

w2 <- ggplot(data=avg, mapping=aes(label=word,size=count)) +
  geom_text_wordcloud(rm_outside = TRUE, area_corr_power = 1) +
  scale_size_area(max_size = 12) +
  theme_bw() +
  labs(title="NYC AirBnb Unique Word Frequency", subtitle="20 Randomly Sampled Reviews")

w3 <- ggplot(data=worst, mapping=aes(label=word,size=count)) +
  geom_text_wordcloud(rm_outside = TRUE, area_corr_power = 1) +
  scale_size_area(max_size = 12) +
  theme_bw() +
  labs(title="NYC AirBnb Unique Word Frequency", subtitle="Worst 20 Reviews")

# a grid.arrange approach cut too much from the boxes, making analysis harder
w1
w2
w3

```

<<<<<<< HEAD
## Box Plot of Price

The learning of this graph is that there are many outliers that may add a bias or skew to analyzing this data. In Brooklyn and Manhattan especially, the data has a lot of points that are far above average. This could mean that analysis of this data may not reflect the average experience, but rather a small subset of very pricey listings. As we found in other graphs, the price does not make a stay better after a certain point. If the AirBNB's keep increasing in quality past this diminishing point, the data on the priciest listings may not be able to answer the question of what exactly makes a good AirBNB. Instead, we may find what makes the top 1% of AirBNBs

```{r boxplot}
boxplot <- as.data.frame(sample_n(listings, 1500))

a1 <- ggplot(data = boxplot %>% filter(priceNum < 2000), 
       mapping = aes(x = neighbourhood_group_cleansed, y = priceNum, fill = neighbourhood_group_cleansed)) +
  geom_boxplot() +
  labs(title = 'Price by Neighborhood',
       subtitle = 'Price < 2000',
       x = 'Neighborhood',
       y = 'Price') +
  guides(fill = FALSE) +
  theme_bw()

a1 + theme(plot.title = element_text(size= 15, face = 'bold'))
  
```


=======
>>>>>>> cf260211609705baac31601a3a3110a99b39f659

## Amenities by Price and Score

One characteristic outside of the price and review score we want to consider is the amenities offered by each Airbnb. As with the other graphs, it seems there isn't much of a correlation between the number of amenities and price or quality. The range of 15-40 amenities generally hold the bulk of the data, meaning that good Airbnb's generally have these many amenities. Some higher listings have upwards of 60 amenities, but it doesn't seem to make them much better than any of the other listings. A reason for this could be that the property owners have different ideas of what amenities mean, so the upper quantiles may have amenities like 'hot tubs' or 'lofts' while lower ones may have 'bathrooms' or 'bedrooms'. In further reports, diving deeper into the amenities themselves could provide a clearer picture of what makes an Airbnb better. The same case can be made with price - there is a diminishing return, but most listings fall within the 15-40 range for amenities.

```{r amenities, warning=FALSE}

amens <- as.data.frame(sample_n(listings, 1500))


# This function takes in a list (with csv), and returns the length - the list may not be casted as such
# In the case of AirBNB, this is more efficient than modifying their amenities list to cast it as a list
listlen <- function(x) {
  length(strsplit(x, ",")[[1]])
}

# Apply the amenities counting function and store it in a new attribute
amens$amenCount <- as.numeric(lapply(amens$amenities, listlen))

a1 <- ggplot(data = amens,
       mapping = aes(x = amenCount, y=review_scores_rating)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme(plot.title = element_text(size= 15, face = 'bold')) +
  labs(title = 'Review Score by Number of Amenities',
       x = 'Number of Amenities',
       y = 'Review Score') +
  guides(fill = FALSE) +
  theme_bw()

a2 <- ggplot(data = amens %>% filter(priceNum < 2000),
       mapping = aes(x = amenCount, y=priceNum)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_log10() +
  theme(plot.title = element_text(size= 15, face = 'bold')) +
  labs(title = 'Price by Number of Amenities',
       subtitle= 'Prices > 2000 removed for easier interpretation',
       x = 'Number of Amenities',
       y = 'Price') +
  guides(fill = FALSE) +
  theme_bw()

grid.arrange(a1, a2)

```

```{r amenSpecific}

  # filter data with regex
filter_punct <- function(data) {
  data <- gsub("[^a-zA-Z, ]","",data, perl=TRUE, fixed = FALSE)
}

amens <- as.data.frame(sample_n(listings, 10))
filter_punct(amens$amenities[1])[1]

#as.vector(amens$amenities[1])

```


```{r dt_setup, message=FALSE, warning=FALSE}

dt_frame <- listings %>% select("review_scores_rating", "host_response_time", "host_response_rate", "host_acceptance_rate", "host_is_superhost", "host_listings_count", "host_total_listings_count", "host_verifications", "host_has_profile_pic", "host_identity_verified", "neighbourhood", "neighbourhood_cleansed", "neighbourhood_group_cleansed", "latitude", "longitude", "property_type", "room_type", "accommodates", "bedrooms", "beds", "amenities", "minimum_nights", "maximum_nights", "has_availability", "availability_365", "number_of_reviews", "number_of_reviews_ltm", "priceNum") %>% filter(!is.na(review_scores_rating))

RNGversion('3.5.2')
set.seed(123)
train_sample <- sample(1:5000, 4000)
RNGversion(getRversion())

# Create classification variable
dt_frame_lbl <- ifelse(dt_frame$review_scores_rating >= 90, "Good", "Poor")

# Take out review scores variable
dt_frame <- dt_frame[-1]

tibble(dt_frame)



# Create training set and labels
bnb_train <- dt_frame[train_sample,]
bnb_train_lbl <- dt_frame_lbl[train_sample,]

# Create test set and labels from any values not in training set
bnb_test <- dt_frame[-train_sample,]
bnb_test_lbl <- dt_frame_lbl[-train_sample,]

```

ml analysis


``` {r dt_run, message=FALSE, warning=FALSE}

#summary(dt_frame$review_scores_rating)

# ggplot(data = dt_frame, mapping = aes(x=review_scores_rating)) +
#   geom_density() +
#   guides(fill = FALSE)

bnb_model <- C5.0(x = bnb_train, y = as.factor(bnb_train_lbl))

bnb_pred <- predict(bnb_model, bnb_test)
bnb_pred

# credit_model <- C5.0(x = credit_train[-17],
#                      y = as.factor(credit_train$default),
#                      trials = 10)
# 
# credit_pred <- predict(credit_model, credit_test)
# credit_pred
# 
# #  dnn = names given to dimensions of table, rows then cols
# 
# CrossTable(credit_test$default, credit_pred,
#            prop.chisq = FALSE, prop.c =FALSE,
#            prop.r = FALSE,
#            dnn = c('actual data', 'predicted data'))

```


## Conclusions

New York City has a lot to do, and a lot of unique experiences per neighborhood and borough. We believe that some while some neighborhoods may not be as highly rated as others, the price you pay for an Airbnb is generally a good way to ensure a decent experience. Our qualitative analysis shows some diminishing return - meaning there is a point where spending more money will not make a better experience. An illustrative fact is that all five boroughs have a high average review score, yet the price increases significantly closer to Manhattan and Brooklyn. Of course, correlation and causation are not the same. Paying more for an Airbnb is NOT the reason it is good. Amenities usually have something to do with quality, meaning a good Airbnb usually has a decent amount of them.    

Because people generally use Airbnbs as a base for their vacation, we believe the biggest determinant in a good experience is the location. Most people simply want an owner that makes it easy to get in, drop their luggage and see the city. Worse AirBNB experiences usually come from necessities not being met - such as a dirty apartment or illegal happenings in or around the Airbnb.    

If these basic needs are met at a baseline, we believe that a positive review and score will be given. A good Airbnb experience is a simple, accomodating apartment in a decent location - one that is not dirty or haunted.

## Limitations

This data was very thorough, expansive and full of opportunities for analysis. While we found some great conclusions, the size of the data presented a limitation for us. Several parts of the data were not computationally feasible for all 37k+ listings, so we took random samples that may not have been represenatative. This study does not utilize many variables to find what correlates with positive reviews, such as bed count or accomodations. In the future, one could use more variables to see what neighborhoods or conditions make for a better experience. One could also analyze each neighborhood or borough independently. Manhattan obviously has another level of experience than the Bronx. Thus, a good AirBNB in the Bronx might be subpar in Manhattan. Analyzing what makes the experience better by neighborhood could be more individualized, as it could be based on different goals and variables. Finally, the number of amenities is not a qualitative analysis. Some owners may list basic necessities as amenities, while some random amenities may add more to the review score. Diving into these would surely give a better analysis.